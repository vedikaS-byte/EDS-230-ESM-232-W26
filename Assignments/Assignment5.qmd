---
title: "Sobol Sensitivity Analysis Assignment 5"
format: html
---

# Sobol Sensitivity Analysis Assignment 5

## Part 1: Paper Discussion

**Selected paper:**

In the study conducted by Zeferina et al. (2021), a Sobol sensitivity analysis revealed that ventilation rate is the most influential parameter for determining both annual and peak cooling demand in large office buildings, contributing to about 50-70% of the uncertainty in HVAC electricity use. This finding is critical for environmental management because it identifies a specific area where building designers and engineers can reduce the problem of oversizing cooling systems; this "system oversizing" problem could lead to inefficient energy use and unnecessary equipment costs. By focusing on more precise control and measurement of ventilation rates, building managers can better predict peak electricity loads, improving the resilience of power networks and reducing the overall carbon footprint of cooling-dominated office buildings.

## Part 2: Atmospheric Conductance and Sobol

#### Import the necessary libraries

```{r}
library(sensitivity)
library(tidyverse)
library(purrr)
library(here)
```

#### Define parameter distributions

```{r}
set.seed(123) # For reproducibility
## Create randomized distributions for constructing X1
windspeed <- rnorm(n = 1000, mean = 3, sd = .50)
height <- runif(n = 1000, min = 3.5, max = 5.5)
k_d <- rnorm(n = 1000, mean = 0.7, sd = 0.7 * 0.01)
k_o <- rnorm(n = 1000, mean = 0.1, sd = 0.1 * 0.01)
X1 <- data.frame(windspeed, height, k_d, k_o)

## Repeat for X2
windspeed <- rnorm(n = 1000, mean = 3, sd = .50)
height <- runif(n = 1000, min = 3.5, max = 5.5)
k_d <- rnorm(n = 1000, mean = 0.7, sd = 0.7 * 0.01)
k_o <- rnorm(n = 1000, mean = 0.1, sd = 0.1 * 0.01)
X2 <- data.frame(windspeed, height, k_d, k_o)
```

#### Generate Sobol parameter matrix

```{r}
# Use sobolSalt for generating matrix of parameter combos to test (recall that we want to see how total variation occurs in the output of the model when one parameter is experimented with)
source(here("R/Catm.R"))
sens_Catm_Sobol <- sobolSalt(model = NULL, X1, X2, nboot = 100)
summary(sens_Catm_Sobol) # Should be empty
```

#### Run model on parameter sets

```{r}
parms <- as.data.frame(sens_Catm_Sobol$X)
#colnames(parms) <- colnames(X1)
colnames(parms) <- c("v", "height", "k_d", "k_o")
res <- pmap_dbl(parms, Catm) # Run catm function for every row
```

#### Calculate Sobol indices

Here, we feed the results from each row based on the `Catm` function into the sensitivity object.

```{r}
sens_Catm_Sobol <- sensitivity::tell(sens_Catm_Sobol, res, res.names = "ga")

# Add column names
row.names(sens_Catm_Sobol$S) <- colnames(parms)
row.names(sens_Catm_Sobol$T) <- colnames(parms)
```

```{r}
## Take a look at the results
print("First order sensitivity (main effects):")
sens_Catm_Sobol$S
```

```{r}
## Take a look at the results
print(paste("Total effects:"))
sens_Catm_Sobol$T
```

#### Visualization and Analysis

Plot the following:

-   uncertainty in the output

-   parameter-output variation for the most sensitive parameters

```{r}
## Combine the parameters with their associated results
param_results <- cbind.data.frame(parms, gs = sens_Catm_Sobol$y)
```

```{r}
## Plot uncertainty 
param_results %>% 
  ggplot(aes(x = gs)) + 
  geom_histogram(fill = "skyblue", color = "white", bins = 30) +
  labs(title = "Uncertainty in Atmospheric Conductance",
       x = "Conductance (mm/s)", 
       y = "Frequency") + 
  geom_vline(xintercept = mean(param_results$gs), col = "red") + 
  theme_light()
```

```{r}
## Plot parameter-output variation for the most sensitive parameters
param_results %>% 
ggplot(aes(x = v, y = gs, color = height)) + 
  geom_point(alpha = 0.5) + 
  scale_color_viridis_c() + 
  labs(title = "Sensitivity of Conductance to Windspeed",
       x = "Windspeed (m/s)",
       y = "Conductance (mm/s)",
       color = "Height (m)") +
  theme_light()
```
